<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    <title>Laura Taylor Design</title>
    <link href="/styles.css" media="screen" rel="stylesheet" type="text/css" />
    <script src="/javascripts/jquery-1.3.2.min.js" type="text/javascript"></script>
    
    <% if @editing %>
      <!-- only need jquery-ui for moving and resizing things. -->
      <script src="/javascripts/jquery-ui-1.7.2.custom.min.js" type="text/javascript"></script>
      <link href="/javascripts/jquery-ui-1.7.2.custom.css" media="screen" rel="stylesheet" type="text/css" />
    <% end %>

    <script type="text/javascript">                                         
      $(document).ready(function() {
        <% if @editing %>
          $('.element').addClass('editable');
          select_element(null);

          // Functions for dragging and resizing elements 
          //
          // position_changed is defined here so it can be used in both drag
          // and resize initializers
          var position_changed = function(event, ui) { 
            $('#selected_x').val(selected.position().left);
            $('#selected_y').val(selected.position().top);
            $('#selected_w').val(selected.width());
            $('#selected_h').val(selected.height());
            $('#selected_z').val(selected.css('z-index'));
          };

          $(".element").draggable({
            grid: [10,10],
            start: position_changed,
            drag: position_changed
          });

          $(".element").resizable({
            autoHide: true,
            aspectRatio: $('#aspect').attr("checked"),
            start: position_changed,
            resize: position_changed
          });


          // Toolbox functions
          //
          $().mousemove(function(e){
            $('#mouse_position').html(e.pageX +', '+ e.pageY);
          }); 

          $("#save").click(function () {
            var query = new Array();

            // Make a query with all the elements' positions and sizes
            $(".element").each(function() {
              query.push([
                $(this).attr('id'),
                $(this).width(),
                $(this).height(),
                $(this).position().left,
                $(this).position().top,
                $(this).css('z-index')
              ]);
            });

            $.post('/save/<%= @page.name %>', {'elements[]': query});
          });

          $('#toolbox').draggable({ 
            handle: 'h1',
            // FIXME: is it possible to make this snap to the bottom of the window too?
            snap: 'body', 
            snapMode: 'inner' 
          });

          // Control resize aspect locking with aspect checkbox
          $('#aspect').change(function () {
            // Hackety hack. Due to bug http://dev.jqueryui.com/ticket/4186
            // I can't change the aspect ratio after create. Instead, have to
            // destroy and recreate the resizable.
            $('.element').resizable('destroy');
            $('.element').resizable({
              autoHide: true,
              aspectRatio: $(this).attr("checked"),
              start: position_changed,
              resize: position_changed
            });
          });

          // Track selected element
          var selected = null;
          function select_element(element) {
            if (selected) selected.removeClass('selected');

            selected = element;
            
            if (selected == null) {
              $('.selected_coordinate').val(null);
              $('.selected_coordinate').attr({disabled: 'disabled'});
              return;
            }

            selected.addClass('selected');
            $('.selected_coordinate').removeAttr('disabled');
            position_changed();
          }

          $('.element').bind('mousedown', function () {
            select_element($(this));
          });

          $(document).bind('click', function(element) {
            // returning true passes the click to the browser
            // returning false stops further click handling
            element = $(element.target); 

            // Ignore clicks on elements and the toolbox
            if (element.closest('.element').length != 0) return true;
            if (element.closest('#toolbox').length != 0) return true;

            select_element(null);
          });


          $('#selected_w').keyup(function(){
            var ratio = selected.height() / selected.width();

            if ($('#aspect').attr("checked")) {
              $('#selected_h').val(Math.round($(this).val() * ratio));
            }
          });

          $('#selected_h').keyup(function(){
            var ratio = selected.width() / selected.height();

            if ($('#aspect').attr("checked")) {
              $('#selected_w').val(Math.round($(this).val() * ratio));
            }
          });

          $('.selected_coordinate').keypress(function(e) {
            if (e.which == 13) {
              this.blur();
              this.focus();
              this.select();
              return true;
            }

            // Ignore non-digits
            if (e.which != 8 && e.which != 0 && (e.which < 48 || e.which > 57)) return false;
            return true;
          });

          $('.selected_coordinate').bind('blur', function (){
            if (!selected) return;

            selected.css({
              left: parseInt($('#selected_x').val(), 10),
              top: parseInt($('#selected_y').val(), 10),
              width: parseInt($('#selected_w').val(), 10),
              height: parseInt($('#selected_h').val(), 10),
              'z-index': parseInt($('#selected_z').val(), 10)
            });
          });
        <% end %>


        currentSection = null;
        currentLink = null;

        $(".section .title").click(function () {
          var oldSection = currentSection;
          currentSection = $(this);

          if (oldSection && currentSection[0] == oldSection[0]) return;

          $.ajax({url: "/show/" + $(this).html(), cache: false, success: function(html){
            $("#main").fadeOut("normal", function() {
              $("#main").html(html);
              $("#main").fadeIn("normal");
            });
          } });

          if (!oldSection) {
            currentSection.next().slideDown("slow");
          } else {
            oldSection.next().slideUp("slow", function() {
              currentSection.next().slideDown("slow");
            });
          }
        });

        $(".link a").click(function () {
          var oldLink = currentLink;
          currentLink = $(this);

          if (oldLink && currentLink[0] == oldLink[0]) return;

          if (oldLink) oldLink.css("color", "#93b2b6");
          $(this).css("color", "#7e7e7e");

          // Fix jump slidedowns by setting a height
          currentLink.next().show();
          var h = currentLink.next().height();
          currentLink.next().hide();

          if (!oldLink) {
            currentLink.next().height(h).slideDown("slow");
          } else {
            oldLink.next().slideUp("slow", function() {
              currentLink.next().height(h).slideDown("slow");
              // Make sure the old one actually is hidden. This can happen
              // when clicking a link in another section, then jumping back
              oldLink.next().css('display', 'none');
            });

            }
          });
      });
  </script> 
  </head>

<body>
  <div id="content">
    <div id="left">
      <% if @editing %>
        <div id="toolbox">
          <h1>Toolbox</h1>
          <label for="aspect">Lock aspect</label><input type="checkbox" id="aspect" checked="checked" />
          <button id="save">save</button>
          <div>Position: <span id="mouse_position">0,0</span></div>
          <div id="selected_element">
            <div>X: <input type="textbox" id="selected_x" class="selected_coordinate" /></div>
            <div>Y: <input type="textbox" id="selected_y" class="selected_coordinate" /></div>
            <div>W: <input type="textbox" id="selected_w" class="selected_coordinate" /></div>
            <div>H: <input type="textbox" id="selected_h" class="selected_coordinate" /></div>
            <div>Z: <input type="textbox" id="selected_z" class="selected_coordinate" /></div>
          </div>
        </div>
      <% end %>

      <img src="/logo.png" id="logo" alt="logo" />

      <% @pages.each do |page| %>
        <div class="section">
          <a href="#" onClick="return false;" class="title"><%= page.name %></a>
          <div class="links">
            <div class="link">
              <a href="#" onClick="return false;">Paper Rocks Scissors For Multimedia</a>
              <div class="description">
                In the time of chimpanzees I was a monkey
                Butane in my veins and I'm out to cut the junkie
                With the plastic eyeballs, spray-paint the vegetables
                Dog food stalls with the beefcake pantyhose
                Kill the headlights and put it in neutral
                Stock car flamin' with a loser and the cruise control
                Baby's in reno with the vitamin d
                Got a couple of couches
              </div> 
            </div>
            <div class="link">
              <a href="#" onClick="return false;">True Type Project</a>
              <div class="description">
                In the time of chimpanzees I was a monkey
                Butane in my veins and I'm out to cut the junkie
                With the plastic eyeballs, spray-paint the vegetables
                Dog food stalls with the beefcake pantyhose
                Kill the headlights and put it in neutral
                Stock car flamin' with a loser and the cruise control
                Baby's in reno with the vitamin d
                Got a couple of couches
              </div> 
            </div>
            <div class="link">
              <a href="#" onClick="return false;">Unicorns + Ponies for Purple Rainbow Cars</a>
              <div class="description">
                In the time of chimpanzees I was a monkey
                Butane in my veins and I'm out to cut the junkie
                With the plastic eyeballs, spray-paint the vegetables
                Dog food stalls with the beefcake pantyhose
                Kill the headlights and put it in neutral
                Stock car flamin' with a loser and the cruise control
                Baby's in reno with the vitamin d
                Got a couple of couches
              </div> 
            </div>
            <div class="link">
              <a href="#" onClick="return false;">Hot Pants and Glitter</a>
              <div class="description">
                In the time of chimpanzees I was a monkey
                Butane in my veins and I'm out to cut the junkie
                With the plastic eyeballs, spray-paint the vegetables
                Dog food stalls with the beefcake pantyhose
                Kill the headlights and put it in neutral
                Stock car flamin' with a loser and the cruise control
                Baby's in reno with the vitamin d
                Got a couple of couches
              </div> 
            </div>
          </div>
        </div>
      <% end %>
    </div>

  <div id="main">
    <%= yield %>
  </div>
</div>
</body>
</html>
